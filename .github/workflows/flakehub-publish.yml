name: Publish to FlakeHub

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags
  workflow_dispatch:  # Allow manual trigger

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    runs-on: depot-ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Setup Cachix (optional)
        uses: cachix/cachix-action@v15
        if: env.CACHIX_AUTH_TOKEN != ''
        with:
          name: betrace
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: false
        continue-on-error: true
        env:
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Verify flake
        run: |
          echo "üîç Verifying flake structure..."
          nix flake check --impure --print-build-logs || echo "‚ö†Ô∏è Flake check skipped (path inputs are unlocked by design)"

      - name: Build all packages
        run: |
          echo "üî® Building all BeTrace packages..."
          nix build .#all --impure --print-build-logs

      - name: Publish to FlakeHub
        uses: DeterminateSystems/flakehub-push@main
        with:
          visibility: public
          name: betracehq/betrace
          tag: ${{ github.ref_name }}
          rolling: true
          rolling-minor: true

      - name: Create GitHub Release Notes
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: |
            ## BeTrace Published to FlakeHub

            **FlakeHub:** https://flakehub.com/flake/betracehq/betrace

            ### Nix Installation

            ```bash
            # Add to your flake.nix
            inputs.betrace.url = "https://flakehub.com/f/betracehq/betrace/${{ github.ref_name }}.tar.gz";

            # Or use latest
            inputs.betrace.url = "https://flakehub.com/f/betracehq/betrace/*.tar.gz";
            ```

            ### Packages Available

            - `betrace.packages.<system>.backend` - Go backend API
            - `betrace.packages.<system>.frontend` - React frontend (BFF)
            - `betrace.packages.<system>.grafana-plugin` - BeTrace Grafana app plugin

            ### Development

            ```bash
            # Clone and develop
            git clone https://github.com/betracehq/betrace
            cd betrace
            nix run .#dev
            ```

            See [README](https://github.com/betracehq/betrace/blob/main/README.md) for full documentation.
