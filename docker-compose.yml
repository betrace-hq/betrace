# BeTrace v1.0 - Docker Compose
# Complete stack: Backend + SigNoz UI + Grafana Plugin

version: '3.8'

services:
  # BeTrace Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: betrace-backend
    ports:
      - "12011:12011"  # HTTP/REST API
      - "12012:12012"  # gRPC
    volumes:
      - betrace-data:/app/data
    environment:
      - BETRACE_PORT_GRPC=12012
      - BETRACE_PORT_BACKEND=12011
      - BETRACE_DATA_DIR=/app/data
      - BETRACE_SIGNATURE_KEY=${BETRACE_SIGNATURE_KEY:-change-in-production}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:12011/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - betrace

  # SigNoz Standalone UI
  signoz-ui:
    build:
      context: ./signoz-betrace-app
      dockerfile: Dockerfile
    container_name: betrace-signoz-ui
    ports:
      - "3001:3001"
    depends_on:
      backend:
        condition: service_healthy
    environment:
      - VITE_BETRACE_BACKEND_URL=http://backend:12011
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    networks:
      - betrace

  # Grafana with BeTrace Plugin
  grafana:
    image: grafana/grafana:latest
    container_name: betrace-grafana
    ports:
      - "12015:3000"
    volumes:
      - ./grafana-betrace-app/dist:/var/lib/grafana/plugins/betrace
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS=betrace-app
      - GF_INSTALL_PLUGINS=
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - betrace

  # Tempo (for Grafana trace storage)
  tempo:
    image: grafana/tempo:latest
    container_name: betrace-tempo
    command: [ "-config.file=/etc/tempo.yaml" ]
    volumes:
      - ./config/tempo.yaml:/etc/tempo.yaml
      - tempo-data:/tmp/tempo
    ports:
      - "3200:3200"   # Tempo HTTP
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    networks:
      - betrace

volumes:
  betrace-data:
    driver: local
  grafana-data:
    driver: local
  tempo-data:
    driver: local

networks:
  betrace:
    driver: bridge
